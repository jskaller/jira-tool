<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jira Tools — Admin</title>
  <style>
    :root{--b:#2563eb;--bg:#f6f7fb;--card:#fff;--border:#e5e7eb;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans','Helvetica Neue',Arial}
    header{background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    main{max-width:1160px;margin:18px auto;padding:0 16px}
    .tabs{display:flex;gap:10px;margin-bottom:12px}
    .tab{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active{background:var(--b);color:#fff;border-color:var(--b)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    button{background:var(--b);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .gray{background:#e5e7eb;color:#111827}
    .green{background:#16a34a}
    .danger{background:#dc2626}
    .muted{color:#6b7280}
    textarea{width:100%;min-height:160px}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <strong>Jira Tools — Admin</strong>
  <div>
    <button class="gray" onclick="logout()">Sign out</button>
  </div>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="settings" onclick="switchTab(event)">Settings</div>
    <div class="tab" data-tab="diagnostics" onclick="switchTab(event)">Diagnostics</div>
  </div>

  <section id="settings" class="card">
    <h2>Jira Settings</h2>
    <div class="row" style="margin-top:8px">
      <input id="jira_base_url" placeholder="Base URL (https://your.atlassian.net)" style="min-width:320px"/>
      <input id="jira_email" placeholder="Jira Email" style="min-width:260px"/>
      <input id="jira_api_token" type="password" placeholder="Jira API Token" style="min-width:280px"/>
      <button onclick="saveSettings()">Save</button>
      <button class="green" onclick="saveTokenDiag()">Save token (diagnostics)</button>
    </div>
    <div class="muted" id="settingsStatus" style="margin-top:10px"></div>
  </section>

  <section id="diagnostics" class="card hidden">
    <h2>Diagnostics</h2>
    <div class="row">
      <button onclick="whoAmI(true)">Who am I (use fields if filled)</button>
      <button class="gray" onclick="discoverProjects(true)">Discover Projects</button>
      <input id="lookup_key" placeholder="Lookup project (key or ID)" />
      <button class="gray" onclick="lookupProject(true)">Lookup Project</button>
      <button onclick="showCreds()">Show resolved creds</button>
      <button class="gray" onclick="showDbSchema()">DB schema</button>
    </div>
    <textarea id="diagOut" placeholder="Diagnostics output…" readonly></textarea>
  </section>
</main>

<script>
function authHeaders(){
  const t = sessionStorage.getItem('token');
  return t ? {'X-Session': t} : {};
}
async function requireAuth(){
  // Try a protected resource to confirm session; if 401, send to login
  const r = await fetch('/api/admin/settings', {headers: authHeaders()});
  if(r.status === 401){
    window.location.href='/login.html'; return false;
  }
  return true;
}
function switchTab(e){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  const tab = e.target.getAttribute('data-tab');
  e.target.classList.add('active');
  document.getElementById(tab).classList.remove('hidden');
}
function logout(){
  sessionStorage.removeItem('token');
  window.location.href='/login.html';
}
async function loadSettings(){
  const ok = await requireAuth(); if(!ok) return;
  const r = await fetch('/api/admin/settings', {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  if(r.ok && b){
    if(b.jira_base_url) document.getElementById('jira_base_url').value = b.jira_base_url;
    if(b.jira_email) document.getElementById('jira_email').value = b.jira_email;
    document.getElementById('settingsStatus').textContent = 'Loaded settings.';
  }else{
    document.getElementById('settingsStatus').textContent = 'Failed to load settings: '+(b.detail||t);
  }
}
async function saveSettings(){
  const payload = {
    jira_base_url: document.getElementById('jira_base_url').value || null,
    jira_email: document.getElementById('jira_email').value || null,
    jira_api_token: document.getElementById('jira_api_token').value || null,
  };
  const r = await fetch('/api/admin/settings', {
    method:'PUT', headers:{'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify(payload)
  });
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  if(r.ok){
    document.getElementById('jira_api_token').value='';
    document.getElementById('settingsStatus').textContent='Saved settings.';
  }else{
    document.getElementById('settingsStatus').textContent='Failed to save: '+(b.detail||t);
  }
}
async function saveTokenDiag(){
  const base = document.getElementById('jira_base_url').value.trim();
  const em = document.getElementById('jira_email').value.trim();
  const tk = document.getElementById('jira_api_token').value.trim();
  if(!tk){ alert('Enter a token first'); return }
  const r = await fetch('/api/jira/diagnostics/save-token', {
    method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify({ token: tk, base_url: base || null, email: em || null })
  });
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
  if(r.ok){ document.getElementById('jira_api_token').value=''; }
  document.querySelector('[data-tab="diagnostics"]').click();
}

// Diagnostics
function addOptionalParams(url){
  const base = document.getElementById('jira_base_url').value.trim();
  const em = document.getElementById('jira_email').value.trim();
  const tk = document.getElementById('jira_api_token').value.trim();
  if(base) url.searchParams.set('base_url', base);
  if(em) url.searchParams.set('email', em);
  if(tk) url.searchParams.set('token', tk);
}
async function whoAmI(useFields){
  const url = new URL('/api/jira/whoami', window.location.origin);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function discoverProjects(useFields){
  const url = new URL('/api/jira/projects', window.location.origin);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function lookupProject(useFields){
  const idOrKey = document.getElementById('lookup_key').value.trim();
  if(!idOrKey){ alert('Enter a key or numeric ID'); return }
  const url = new URL('/api/jira/project', window.location.origin);
  url.searchParams.set('id_or_key', idOrKey);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function showCreds(){
  const url = new URL('/api/jira/diagnostics/creds', window.location.origin);
  addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function showDbSchema(){
  const r = await fetch('/api/jira/diagnostics/db-schema', {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}

(async function init(){
  // If no session, try once; if 401 redirect to login.
  await requireAuth();
  await loadSettings();
})(); 
</script>
</body>
</html>
