<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin · Jira Reporting</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>
    async function jget(url){ const r=await fetch(url); return r.json(); }
    async function jput(url, body){ const r=await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }
    async function jpost(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }

    async function refresh() {
      const cfg = await jget('/api/admin/config');
      document.getElementById('current').textContent = JSON.stringify(cfg, null, 2);
      document.getElementById('base').value = cfg.jira_base_url || '';
      document.getElementById('email').value = cfg.jira_email || '';
    }
    async function save() {
      const body = {
        jira_base_url: document.getElementById('base').value || null,
        jira_email: document.getElementById('email').value || null,
        jira_api_token: document.getElementById('token').value || null
      };
      try {
        const j = await jput('/api/admin/config', body);
        document.getElementById('status').textContent = 'Saved. has_token=' + (j.has_token ?? 'unknown');
        document.getElementById('token').value='';
        await refresh();
      } catch (e) {
        document.getElementById('status').textContent = 'Failed to save: ' + e;
      }
    }
    async function test() {
      try {
        const r = await fetch('/api/admin/test-connection', {method:'POST'});
        document.getElementById('status').textContent = r.ok ? 'Connection OK' : 'Connection failed';
      } catch (e) {
        document.getElementById('status').textContent = 'Connection test error: ' + e;
      }
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('save').addEventListener('click', save);
      document.getElementById('test').addEventListener('click', test);
      refresh();
    });
  </script>
</head>
<body>
  <header>
    <h1>Admin</h1>
    <nav>
      <a class="active" href="/admin.html">Admin</a>
      <a href="/reports.html">Reports</a>
    </nav>
  </header>
  <main>
    <div class="card">
      <h3>Configuration</h3>
      <div class="row">
        <div style="flex:1 1 280px">
          <label>Base URL</label>
          <input id="base" placeholder="https://your-domain.atlassian.net">
        </div>
        <div style="flex:1 1 240px">
          <label>Email</label>
          <input id="email" placeholder="name@company.com">
        </div>
      </div>
      <div class="row">
        <div style="flex:1 1 340px">
          <label>API Token</label>
          <input id="token" placeholder="Paste API token">
        </div>
        <div style="align-self:flex-end">
          <button id="save">Save</button>
          <button id="test">Test connection</button>
        </div>
      </div>
      <p id="status" class="hint"></p>
    </div>

    <div class="card">
      <h3>Current</h3>
      <pre id="current" style="white-space:pre-wrap"></pre>
    </div>
  </main>
  <footer>© Jira Reporting</footer>
</body>
</html>
