<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jira Tools — Admin</title>
  <style>
    :root{--b:#2563eb;--bg:#f6f7fb;--card:#fff;--border:#e5e7eb;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans','Helvetica Neue',Arial}
    header{background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    main{max-width:1180px;margin:18px auto;padding:0 16px}
    .tabs{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
    .tab{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active{background:var(--b);color:#fff;border-color:var(--b)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    button{background:var(--b);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .gray{background:#e5e7eb;color:#111827}
    .green{background:#16a34a}
    .danger{background:#dc2626}
    .muted{color:#6b7280}
    textarea{width:100%;min-height:140px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px}
    .hidden{display:none !important}
    .kv{display:grid;grid-template-columns: 240px 1fr; gap:8px 12px}
    .w200{min-width:200px}.w260{min-width:260px}.w320{min-width:320px}
    /* Modal */
    #userModal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:grid;place-items:center}
    #userModal.hidden{display:none !important}
  </style>
</head>
<body>
<header>
  <strong>Jira Tools — Admin</strong>
  <div>
    <button class="gray" onclick="logout()">Sign out</button>
  </div>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="settings" onclick="switchTab(event)">Settings</div>
    <div class="tab" data-tab="users" id="tab-users" onclick="switchTab(event)">Users</div>
    <div class="tab" data-tab="ingest" onclick="switchTab(event)">Ingest</div>
    <div class="tab" data-tab="diagnostics" onclick="switchTab(event)">Diagnostics</div>
  </div>

  <section id="settings" class="card">
    <h2>Core Settings</h2>
    <div class="kv">
      <label>Jira Base URL</label><input id="jira_base_url" class="w320" placeholder="https://your.atlassian.net" />
      <label>Jira Email</label><input id="jira_email" class="w260" placeholder="you@example.com" />
      <label>Jira API Token</label><input id="jira_api_token" class="w320" type="password" placeholder="Paste token (use Save token button below)" />
      <label>Window (days)</label><input id="default_window_days" class="w200" type="number" min="1" step="1" placeholder="180" />
      <label>Business hours start</label><input id="business_hours_start" class="w200" placeholder="09:00" />
      <label>Business hours end</label><input id="business_hours_end" class="w200" placeholder="17:00" />
      <label>Business days (CSV)</label><input id="business_days" class="w320" placeholder="Mon,Tue,Wed,Thu,Fri" />
      <label>Timezone</label><input id="timezone" class="w200" placeholder="America/New_York" />
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="saveSettings()">Save</button>
      <button class="green" onclick="saveTokenDiag()">Save token (diagnostics)</button>
      <span id="settingsStatus" class="muted"></span>
    </div>
  </section>

  <section id="users" class="card hidden">
    <h2>Users</h2>
    <div class="row" style="margin-bottom:10px">
      <button onclick="reloadUsers()">Reload</button>
      <button class="green" onclick="openUserModal()">Add user</button>
      <span id="usersStatus" class="muted"></span>
    </div>
    <div id="usersFeatureMissing" class="muted hidden">User management endpoints are not available on this server (skipping Users tab).</div>
    <table id="usersTable">
      <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody id="usersTbody"></tbody>
    </table>
  </section>

  <section id="ingest" class="card hidden">
    <h2>Ingest</h2>
    <div class="kv">
      <label>Projects (comma/space separated; keys or names)</label><input id="ing_projects" class="w320" placeholder="MEDA, OTHERPROJ" />
      <label>Labels (comma/space separated)</label><input id="ing_labels" class="w320" placeholder="prod, urgent" />
      <label>Extra JQL</label><input id="ing_jql" class="w320" placeholder="assignee = currentUser()" />
      <label>Window (days)</label><input id="ing_days" type="number" class="w200" placeholder="180" />
      <label>Max issues</label><input id="ing_max" type="number" class="w200" placeholder="25000" />
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="runIngest()">Run ingest</button>
      <span id="ingestStatus" class="muted"></span>
    </div>
    <textarea id="ingestOut" placeholder="Ingest output…" readonly></textarea>
  </section>

  <section id="diagnostics" class="card hidden">
    <h2>Diagnostics</h2>
    <div class="row">
      <button onclick="whoAmI(true)">Who am I (use fields if filled)</button>
      <button class="gray" onclick="discoverProjects(true)">Discover Projects</button>
      <input id="lookup_key" placeholder="Lookup project (key or ID)" />
      <button class="gray" onclick="lookupProject(true)">Lookup Project</button>
      <button onclick="showCreds()">Show resolved creds</button>
      <button class="gray" onclick="showDbSchema()">DB schema</button>
    </div>
    <textarea id="diagOut" placeholder="Diagnostics output…" readonly></textarea>
  </section>
</main>

<!-- User modal -->
<div id="userModal" class="hidden" aria-hidden="true">
  <div class="card" style="width:520px" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <h3 id="userModalTitle">New user</h3>
    <div class="kv">
      <label>Email</label><input id="um_email" class="w320"/>
      <label>Name</label><input id="um_name" class="w320"/>
      <label>Role</label>
      <select id="um_role" class="w200"><option>admin</option><option>user</option></select>
      <label>Password</label><input id="um_password" type="password" class="w320" placeholder="Set password"/>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="green" onclick="saveUser()">Save</button>
      <button class="gray" onclick="closeUserModal()">Cancel</button>
      <span id="userModalStatus" class="muted"></span>
    </div>
  </div>
</div>

<script>
function authHeaders(){ const t=sessionStorage.getItem('token'); return t?{'X-Session':t}:{}};
async function requireAuth(){
  const r = await fetch('/api/admin/settings', {headers: authHeaders()});
  if(r.status === 401){ window.location.href='/login.html'; return false;}
  return true;
}
function switchTab(e){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  const tab = e.target.getAttribute('data-tab');
  e.target.classList.add('active');
  const sec = document.getElementById(tab);
  sec.classList.remove('hidden');
  if(tab==='users'){ maybeLoadUsers(); }
}
function logout(){ sessionStorage.removeItem('token'); window.location.href='/login.html'; }

// Settings
async function loadSettings(){
  const r = await fetch('/api/admin/settings', {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  if(r.ok && b){
    const map = ['jira_base_url','jira_email','default_window_days','business_hours_start','business_hours_end','business_days','timezone'];
    map.forEach(k=>{ if(b[k]!==undefined && document.getElementById(k)) document.getElementById(k).value = b[k]; });
    document.getElementById('settingsStatus').textContent='Loaded settings.';
  }else{
    document.getElementById('settingsStatus').textContent='Failed to load settings: '+(b.detail||t);
  }
}
async function saveSettings(){
  const payload = {
    jira_base_url: val('jira_base_url'),
    jira_email: val('jira_email'),
    jira_api_token: val('jira_api_token') || null,
    default_window_days: num('default_window_days'),
    business_hours_start: val('business_hours_start'),
    business_hours_end: val('business_hours_end'),
    business_days: val('business_days'),
    timezone: val('timezone')
  };
  const r = await fetch('/api/admin/settings', {method:'PUT', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(payload)});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  if(r.ok){ if(payload.jira_api_token) document.getElementById('jira_api_token').value=''; document.getElementById('settingsStatus').textContent='Saved settings.';}
  else{ document.getElementById('settingsStatus').textContent='Failed to save: '+(b.detail||t); }
}
async function saveTokenDiag(){
  const base = val('jira_base_url'); const em = val('jira_email'); const tk = val('jira_api_token');
  if(!tk){ alert('Enter a token first'); return }
  const r = await fetch('/api/jira/diagnostics/save-token', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify({ token: tk, base_url: base||null, email: em||null })});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  alert(r.ok ? 'Token saved.' : ('Failed: '+(b.detail||t)));
  if(r.ok){ document.getElementById('jira_api_token').value=''; }
}

// Users — feature detect and lazy load
let usersFeature = {checked:false, available:false};
async function featureDetectUsers(){
  if(usersFeature.checked) return usersFeature.available;
  usersFeature.checked = true;
  try{
    const r = await fetch('/api/users', {headers: authHeaders()});
    if(r.status === 404){
      usersFeature.available = Falsey(); // force false
    }else{
      usersFeature.available = r.ok;
    }
  }catch(e){
    usersFeature.available = false;
  }
  const tab = document.getElementById('tab-users');
  const sec = document.getElementById('users');
  if(!usersFeature.available){
    if(tab) tab.classList.add('hidden');
    if(sec) sec.classList.add('hidden');
  }
  return usersFeature.available;
}
function Falsey(){ return false; } // helper to keep minified style

async function maybeLoadUsers(){
  const ok = await featureDetectUsers();
  const sec = document.getElementById('users');
  if(!ok){
    // Show a tiny note that the feature is missing, but keep the rest hidden
    if(sec){
      sec.classList.remove('hidden');
      document.getElementById('usersFeatureMissing')?.classList.remove('hidden');
      document.getElementById('usersTable')?.classList.add('hidden');
    }
    return;
  }
  await reloadUsers();
}
async function reloadUsers(){
  const r = await fetch('/api/users', {headers: authHeaders()});
  const t = await r.text(); let b=[]; try{ b=JSON.parse(t) }catch{}
  const tbody = document.getElementById('usersTbody'); tbody.innerHTML='';
  if(!r.ok){ document.getElementById('usersStatus').textContent='Failed: '+(b.detail||t); return }
  b.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.email}</td><td>${escapeHtml(u.name||'')}</td><td>${u.role||''}</td><td>${u.created_at||''}</td>
      <td><button class="gray" data-id="${u.id}">Edit</button> <button class="danger" data-del="${u.id}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-id]').forEach(btn=>btn.onclick=async (e)=>{
    const id = e.target.getAttribute('data-id');
    const r = await fetch('/api/users/'+id, {headers: authHeaders()});
    const t = await r.text(); let u={}; try{ u=JSON.parse(t) }catch{}
    if(r.ok) openUserModal(u); else alert('Load failed: '+(u.detail||t));
  });
  tbody.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=async (e)=>{
    const id = e.target.getAttribute('data-del');
    if(!confirm('Delete this user?')) return;
    const r = await fetch('/api/users/'+id, {method:'DELETE', headers: authHeaders()});
    if(r.ok) reloadUsers(); else { const t=await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}; alert('Delete failed: '+(b.detail||t)); }
  });
  document.getElementById('usersStatus').textContent = b.length+' users';
}

// Modal open/close — never open automatically
function openUserModal(user){
  const modal = document.getElementById('userModal');
  modal.classList.remove('hidden');
  modal.setAttribute('aria-hidden','false');
  document.getElementById('userModalStatus').textContent='';
  if(user){
    document.getElementById('userModalTitle').textContent='Edit user';
    document.getElementById('um_email').value=user.email; document.getElementById('um_email').disabled=true;
    document.getElementById('um_name').value=user.name||'';
    document.getElementById('um_role').value=user.role||'user';
    document.getElementById('um_password').value='';
    modal.dataset.userId = user.id;
  }else{
    document.getElementById('userModalTitle').textContent='New user';
    ['um_email','um_name','um_password'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('um_email').disabled=false;
    document.getElementById('um_role').value='user';
    delete modal.dataset.userId;
  }
}
function closeUserModal(){
  const modal = document.getElementById('userModal');
  modal.classList.add('hidden');
  modal.setAttribute('aria-hidden','true');
}
document.getElementById('userModal').addEventListener('click', (e)=>{
  if(e.target.id === 'userModal'){ closeUserModal(); }
});
document.addEventListener('keydown',(e)=>{
  if(e.key === 'Escape'){ closeUserModal(); }
});

async function saveUser(){
  const modal = document.getElementById('userModal');
  const id = modal.dataset.userId;
  const payload = { email: val('um_email'), name: val('um_name'), role: document.getElementById('um_role').value, password: val('um_password')||undefined };
  const url = id ? '/api/users/'+id : '/api/users';
  const method = id ? 'PUT' : 'POST';
  const r = await fetch(url, {method, headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(payload)});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  if(r.ok){ closeUserModal(); reloadUsers(); } else { document.getElementById('userModalStatus').textContent='Failed: '+(b.detail||t); }
}

// Ingest
function splitCSV(s){ return (s||'').split(/[, ]+/).map(x=>x.trim()).filter(Boolean); }
async function runIngest(){
  const payload = {
    jira_base_url: val('jira_base_url')||null,
    jira_email: val('jira_email')||null,
    jira_api_token: null, // do not send token unless typed; server resolves stored token
    projects: splitCSV(val('ing_projects')),
    labels: splitCSV(val('ing_labels')),
    jql: val('ing_jql')||'',
    updated_window_days: num('ing_days')||num('default_window_days')||180,
    max_issues: num('ing_max')||25000
  };
  document.getElementById('ingestStatus').textContent='Running…';
  const r = await fetch('/api/jira/ingest', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(payload)});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('ingestOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR '+r.status+':\n'+(b.detail||t));
  document.getElementById('ingestStatus').textContent = r.ok ? 'Done.' : 'Failed.';
}

// Diagnostics
function addOptionalParams(url){
  const base = val('jira_base_url'); const em = val('jira_email'); const tk = val('jira_api_token');
  if(base) url.searchParams.set('base_url', base);
  if(em) url.searchParams.set('email', em);
  if(tk) url.searchParams.set('token', tk);
}
async function whoAmI(useFields){
  const url = new URL('/api/jira/whoami', window.location.origin);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function discoverProjects(useFields){
  const url = new URL('/api/jira/projects', window.location.origin);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function lookupProject(useFields){
  const idOrKey = document.getElementById('lookup_key').value.trim();
  if(!idOrKey){ alert('Enter a key or numeric ID'); return }
  const url = new URL('/api/jira/project', window.location.origin);
  url.searchParams.set('id_or_key', idOrKey);
  if(useFields) addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function showCreds(){
  const url = new URL('/api/jira/diagnostics/creds', window.location.origin);
  addOptionalParams(url);
  const r = await fetch(url, {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}
async function showDbSchema(){
  const r = await fetch('/api/jira/diagnostics/db-schema', {headers: authHeaders()});
  const t = await r.text(); let b={}; try{ b=JSON.parse(t) }catch{}
  document.getElementById('diagOut').value = r.ok ? JSON.stringify(b, null, 2) : ('ERROR ' + r.status + ':\n' + (b.detail || t));
}

// utils
function val(id){ return (document.getElementById(id)?.value||'').trim(); }
function num(id){ const v=parseInt(val(id),10); return isFinite(v)?v:null; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

(async function init(){
  const ok = await requireAuth(); if(!ok) return;
  await loadSettings();
  // Feature-detect users endpoints; hide Users tab if missing
  await featureDetectUsers();
})(); 
</script>
</body>
</html>
