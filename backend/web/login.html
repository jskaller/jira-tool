<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sign In · Jira Reporting</title>
  <link rel="stylesheet" href="/styles.css" />
  <script>
    async function init() {
      try {
        const r = await fetch('/api/auth/bootstrap');
        const j = await r.json();
        const hint = document.getElementById('hint');
        if (j.bootstrap_email) {
          document.getElementById('email').value = j.bootstrap_email;
          hint.textContent = 'Bootstrap: ' + j.bootstrap_email + ' / (your BOOTSTRAP_ADMIN_PASSWORD)';
        }
        if (!j.has_users) {
          document.getElementById('sync').style.display = 'inline-block';
        }
      } catch {}
    }
    async function login(ev) {
      ev.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const r = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, password})});
      const j = await r.json().catch(()=>({}));
      const status = document.getElementById('status');
      if (r.ok) {
        status.textContent = 'Signed in as ' + j.email;
        setTimeout(()=>{ window.location.href = '/admin.html'; }, 400);
      } else {
        status.textContent = 'Login failed: ' + (j.detail || r.status);
      }
    }
    async function syncBootstrap() {
      const r = await fetch('/api/auth/bootstrap-sync', {method:'POST'});
      const j = await r.json().catch(()=>({}));
      const status = document.getElementById('status');
      if (r.ok) {
        status.textContent = 'Bootstrap user synced for ' + j.email + '. Now sign in.';
      } else {
        status.textContent = 'Sync failed: ' + (j.detail || r.status);
      }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <header>
    <h1>Sign In</h1>
    <nav>
      <a href="/admin.html">Admin</a>
      <a href="/reports.html">Reports</a>
    </nav>
  </header>
  <main>
    <div class="card">
      <form onsubmit="login(event)">
        <div class="row">
          <div style="flex:1 1 280px">
            <label>Email</label>
            <input id="email" placeholder="name@company.com">
          </div>
          <div style="flex:1 1 200px">
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••">
          </div>
          <div style="align-self:flex-end">
            <button type="submit">Sign In</button>
          </div>
        </div>
        <p id="status" class="hint"></p>
        <p id="hint" class="hint"></p>
        <button id="sync" type="button" onclick="syncBootstrap()" style="display:none">Sync bootstrap user</button>
        <p class="hint">If you changed BOOTSTRAP_ADMIN_EMAIL/PASSWORD in .env, click "Sync bootstrap user" first.</p>
      </form>
    </div>
  </main>
</body>
</html>
