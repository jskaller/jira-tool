<!-- patch-only snippet to add Discover Projects UI; integrate manually if needed -->
<div class="row mt-2">
  <button class="btn gray" onclick="discoverProjects()">Discover Projects</button>
  <span id="projectsInfo" class="muted"></span>
</div>
<script>
async function discoverProjects(){
  const base = document.getElementById('jira_base_url').value
  const email = document.getElementById('jira_email').value
  const token = document.getElementById('jira_api_token').value
  const info = document.getElementById('projectsInfo')
  info.textContent = 'Loading projects…'
  try{
    const url = new URL('/api/jira/projects', window.location.origin)
    url.searchParams.set('base_url', base)
    url.searchParams.set('email', email)
    url.searchParams.set('token', token)
    const res = await fetch(url, { headers: authHeaders() })
    const t = await res.text(); let b={}; try{ b=JSON.parse(t) }catch{}
    if(!res.ok){ info.textContent = b.detail || ('Error ('+res.status+') '+t); return }
    const rows = (b.projects||[]).map(p=>`${p.key} — ${p.name} (#${p.id})`).join(', ')
    info.textContent = rows.length ? ('Visible projects: ' + rows) : 'No projects visible with these credentials.'
  }catch(e){
    info.textContent = 'Failed: ' + (e && e.message ? e.message : e)
  }
}
</script>
